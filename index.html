<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
		<title>book</title>
        <script src = "keymappings.js"></script>
		<style>
			body { margin: 0; }
		</style>
    </head>
    <body>
        <canvas id = "c"></canvas>
    </body>
    <script type = "module">
        import * as THREE from 'https://unpkg.com/three@0.126.1/build/three.module.js';

        const json = {
            "books": [
                {
                "name": "Sapiens A Brief History of Humankind",
                "author": "Yuval Noah Harari", 
                "cover": "http://covers.openlibrary.org/b/ISBN/9780099590088-L.jpg"
                },
                {
                "name": "Homo Deus A Brief History of Tomorrow",
                "author": "Yuval Noah Harari", 
                "cover": "http://covers.openlibrary.org/b/ISBN/9780062464347-L.jpg"
                }]
        };

        let renderer;
        let scene;
        let camera;
        let books = [];

        const bookOffset = 10; //distance between two books

        //resize drawingbuffer size (canvas internal resolution)
        function resizeRendererToDisplaySize(renderer) {
                const canvas = renderer.domElement;
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                const needResize = canvas.width !== width || canvas.height !== height;

                if (needResize) {
                    renderer.setSize(width, height, false);
                }
                return needResize;
        }

        function animate(time) {
                time *= 0.001;  // convert time to seconds

                if(resizeRendererToDisplaySize(renderer)){
                    console.log("update drawingbuffer size");
                    const canvas = renderer.domElement;
                    camera.aspect = canvas.clientWidth / canvas.clientHeight;
                    camera.updateProjectionMatrix();
                }

                /*books.forEach((book)=>{
                    book.rotation.y += Math.PI * 0.001;
                })*/
                
                renderer.render(scene, camera);
                
                requestAnimationFrame(animate);
        }

        function addBooks(scene, textureLoader){
            let x = 0;
            json["books"].forEach((book)=> {
                console.log(book);
                const geometry = new THREE.BoxGeometry(7,10,0.5);

                const materials = [
                    new THREE.MeshPhongMaterial({color: 0xFFFFFF}),
                    new THREE.MeshPhongMaterial({color: 0xFFFFFF}),
                    new THREE.MeshPhongMaterial({color: 0xFFFFFF}),
                    new THREE.MeshPhongMaterial({color: 0xFFFFFF}), //bottom/top?
                    new THREE.MeshPhongMaterial({map: textureLoader.load(book.cover)}),
                    new THREE.MeshPhongMaterial({color: 0xFFFFFF}), //back
                ];

                const mesh = new THREE.Mesh(geometry, materials);
                mesh.position.x = x;
                mesh.position.y = 5;
                mesh.position.z = 0;

                books.push(mesh);

                scene.add(mesh);

                x += bookOffset;
            });     
        }

        function init(){
            scene = new THREE.Scene();
            scene.background = new THREE.Color('grey');

            camera = new THREE.PerspectiveCamera(75, 2, 0.1, 1000);
            camera.position.set(0, 5, 20);
            
            const canvas = document.querySelector('#c');
            renderer = new THREE.WebGLRenderer({canvas});
            renderer.physicallyCorrectLights = true;

            
            const color = 0xFFFFFF;
            const intensity = 1;
            const light = new THREE.PointLight(color, intensity);
            light.power = 4000;
            light.decay = 1.6;

            light.position.x = 0;
            light.position.y = 5;
            light.position.z = 20;

            /*const helper = new THREE.PointLightHelper(light);
            scene.add(helper);*/

            scene.add(light);
            scene.add(light.target);

            window.addEventListener("keydown", function(){
                var keyCode = event.keyCode;
                switch (keyCode) {
                    case KEYS.LEFT:{
                        if(camera.position.x > 0){
                            camera.position.x -= bookOffset;
                            light.position.x -= bookOffset;
                        }
                        break;
                    }
                    case KEYS.RIGHT:{
                        if(camera.position.x < (books.length-1) * bookOffset){
                            camera.position.x += bookOffset;
                            light.position.x += bookOffset;
                        }
                        break;
                    }
                }
            }, false);

            const textureLoader = new THREE.TextureLoader();
            addBooks(scene, textureLoader);
  


            //draw x,y,z axes
            //const axesHelper = new THREE.AxesHelper( 5 );
            //scene.add( axesHelper );

            requestAnimationFrame(animate);
        }

        init();
    </script>
    <style>
        html, body {
           margin: 0;
           height: 100%;
        }
        #c {
           width: 100%;
           height: 100%;
           display: block;
        }
    </style>
</html>